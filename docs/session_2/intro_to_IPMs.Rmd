---
title: "Introduction to Integrated Populations Models"
# subtitle: "Mark Scheuerell"  
# subtitle: "WA-BC AFS Meeting<br>Spokane, WA<br>29 April 2024"  
author: 
#  - "Mark Scheuerell"
  - "_WA-BC AFS Meeting<br>Spokane, WA<br>29 April 2024_"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "my-theme.css"]
    nature:
      slideNumberFormat: ""
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      # countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width=8, fig.height=4, fig.retina=3,
  out.width = "100%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE
)

## set random seed
set.seed(666)

## load {icons} for font awesome
library(icons)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_duo(
  primary_color = "#FFFFFF",
  secondary_color = "#23395b",
  # secondary_color = "#FF961C",
  title_slide_text_color = "#FFFFFF",
  title_slide_background_color = "#23395b",
  colors = c(
    red = "#f34213",
    purple = "#844870",
    orange = "#FF961C",
    green = "#339933",
    white = "#FFFFFF",
    blue = "#488fdf",
    aqua = "#80cdc1",
    gray = "#808080",
    lightgray = "#bdbdbd"
),
  header_font_google = google_font("Roboto Condensed", "400", "400i", "700"),
  text_font_google = google_font("Cabin", "400", "400i", "700"),
)
```

class: center, middle, inverse

# RUN RECONSTRUCTION:

# Classical approach

---

class: center
background-image: url(figs/ipm_1.png)
background-position: 50% 50%
background-size: 90%

# Build a brood table

---

class: center
background-image: url(figs/ipm_2b.png)
background-position: 50% 50%
background-size: 90%

# Build a brood table

<br><br><br><br><br><br><br><br><br><br><br>

$$\Large ~~~~~~~~~~~~~ N_{y,a} = p_a S_y$$

---

class: center
background-image: url(figs/ipm_3.png)
background-position: 50% 50%
background-size: 90%

# Build a brood table

---

class: center
background-image: url(figs/ipm_4.png)
background-position: 50% 50%
background-size: 90%

# Build a brood table

---

class: center
background-image: url(figs/ipm_5.png)
background-position: 50% 50%
background-size: 90%

# Build a brood table

---

class: center
background-image: url(figs/ipm_6.png)
background-position: 50% 50%
background-size: 90%

# Build a brood table

---

# Problems with this approach

### .blue[1) Spawner counts are not exhaustive & contain errors]


---

# Covariate measured with error

### .center.blue[Ricker model]

$$\Large R_t = \alpha S_t \exp (- \beta S_t + \epsilon_t)$$


---

# Covariate measured with error

### .center.blue[Ricker model]

$$\Large R_t = \alpha S_t \exp (- \beta S_t + \epsilon_t) \\ 
\Large \Downarrow \\
\Large \log \left( \frac{R_t}{S_t} \right) = \log (\alpha) - \beta \underline{S_t} + \epsilon_t \\
\Large \Downarrow \\
\Large y_i = \alpha + \beta \underline{x_i} + \epsilon_i$$


---

# Problems with this approach

### .blue[1) Spawner counts are not exhaustive & contain errors]

### .green[2) Age-composition data are typically non-exhaustive & imprecise]


---

class: center
background-image: url(figs/ipm_2b.png)
background-position: 50% 50%
background-size: 90%

# Typical age expansion

<br><br><br><br><br><br><br><br><br><br><br>

### .blue[&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fish sampled for age comp << total return!]

---

# Problems with this approach

### .blue[1) Spawner counts are not exhaustive & contain errors]

### .green[2) Age-composition data are typically non-exhaustive & imprecise]

### .orange[3) Missing data cause problems]

---

class: center
background-image: url(figs/ipm_7.png)
background-position: 50% 50%
background-size: 90%

# Problems with missing data

---

class: center
background-image: url(figs/ipm_8.png)
background-position: 50% 50%
background-size: 90%

# Problems with missing data

---

class: center
background-image: url(figs/ipm_9b.png)
background-position: 50% 50%
background-size: 90%

# Problems with missing data

<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

### .red[We just lost 4 pairs of missing data!]

---

# Problems with this approach

### .blue[1) Spawner counts are not exhaustive & contain errors]

### .green[2) Age-composition data are typically non-exhaustive & imprecise]

### .orange[3) Missing data cause problems]

### .purple[4) Stock-Recruit models are process models, not observation models]

---

class: center
background-image: url(figs/ipm_10b.png)
background-position: 50% 50%
background-size: 90%

# Observation model

<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

### .red[Time-ordering is irrelevant; estimated] $\color{#F34213}{R_1}$ .red[has no effect on any later] $\color{#F34213}{S_t}$


---

class: center, middle, inverse

# Integrated population models


---

# Integrated population models

### ðŸ˜ƒ &nbsp; .blue[Do make the model outputs match the data]

### ðŸ˜± &nbsp; .red[Don't pre-process the data to match the model]


---

class: center
background-image: url(figs/ipm_11.png)
background-position: 50% 80%
background-size: 90%


---

class: center
background-image: url(figs/ipm_12.png)
background-position: 50% 50%
background-size: 90%

# Creating recruits from spawners


---

# Forms for stock-recruit model

### .center.blue[Ricker model with autocorrelated errors]

$$\Large R_t = \alpha S_t \exp (- \beta S_t + \epsilon_t) \\ 
\Large \Downarrow \\
\Large \log (R_t) = \log (\alpha) + \log(S_t) - \beta S_t + \epsilon_t$$

$$\Large \epsilon_t \sim \text{N}(\phi \epsilon_{t-1}, q)$$


---

# Forms for stock-recruit model

### .center.blue[Ricker model with covariates]

$$\Large R_t = \alpha S_t \exp (- \beta S_t + \gamma X_{t-h} + \epsilon_t) \\ 
\Large \Downarrow \\
\Large \log (R_t) = \log (\alpha) + \log(S_t) - \beta S_t + \gamma X_{t-h} + \epsilon_t$$

$$\Large \epsilon_t \sim \text{N}(\phi \epsilon_{t-1}, q)$$


---

class: center
background-image: url(figs/ipm_13.png)
background-position: 50% 50%
background-size: 90%

# Projecting recruits forward


---

# Projecting recruits forward

<br>

### .center.blue[recruits-by-age = (proportion-by-age) &times; (total recruits)]

<br>

$$\LARGE N_{a,t} = p_{a, t-a} R_{t-a}$$

---

# Observation models for spawners

### .pull-left.center[True spawners]

### .pull-right[&nbsp;]

.pull-left[$$\Large S_t = N_t - C_t$$]

### .pull-right.blue[True spawners are difference<br>between returns and catch]


### .pull-left.center[<br><br><br>Observed spawners]

### .pull-right[<br><br><br>&nbsp;]

.pull-left[$$\Large \log E_t = \text{N}(\log S_t, \sigma_S)$$]

### .pull-right.green[Measured escapement is<br>estimate of true spawners]


---

# Observation models for age-comp

$$\Large D_t = \sum_a O_{a,t}$$


---

# Observation models for age-comp

### .pull-left.center[Total returns]

### .pull-right[&nbsp;]

.pull-left[$$\Large D_t = \sum_a O_{a,t}$$]

### .pull-right.blue[Number of fish observed<br>in age class _a_ in year _t_]


---

### .pull-left.center[<br><br><br>Proportion by age]

### .pull-right[<br><br><br>&nbsp;]

.pull-left[$$\Large \pi_t =$$]

### .pull-right.green[Number of fish predicted<br>in age class _a_ in year _t_]


---

class: center
background-image: url(figs/ipm_14.png)
background-position: 50% 50%
background-size: 90%

# Feedback between R & S

---

class: center, middle, inverse

# EXAMPLE: Skagit River

---

class: left
background-image: url(figs/skagit.png)
background-position: 70% 50%
background-size: 75%

# Skagit<br>River

---

# Characterize uncertainty between steelhead

## .blue[1) spawners and offspring]

## .green[2) productivity and environmental conditions]

---

# Skagit River steelhead

## .right.blue[Escapement, harvest & age data from 1978-2018]

## .right.green[Effects of streamflows & hatchery releases]

---

# Integrated population model

## .blue.under[State model]

## .blue[Offspring] = f(.blue[Spawners], .green[Streamflows], .orange[Hatchery fish])

---

# Integrated population model

## .blue.under[State model]

## .blue[Offspring] = f(.blue[Spawners], .green[Streamflows], .orange[Hatchery fish])

## .purple.under[Observation models]

## .purple[Spawners] = g(.blue[Spawners], .gray[Harvest])

## .purple[Ages] = h(.blue[Offspring])

---

class: frimg, center
background-image: url(figs/flow_effects_summer.png)
background-position: 50% 55%
background-size: 85%

# Flow effects on productivity

.citation.gray[Scheuerell et al. (2021)]

---

class: frimg, center
background-image: url(figs/flow_effects_winter.png)
background-position: 50% 50%
background-size: 85%

# Flow effects on productivity

.citation.gray[Scheuerell et al. (2021)]

---

class: frimg, center
background-image: url(figs/H_effects.png)
background-position: 50% 55%
background-size: 85%

# Hatchery effect on productivity

.citation.gray[Scheuerell et al. (2021)]

---

class: frimg, center
background-image: url(figs/BH_form.png)
background-position: 50% 77%
background-size: 63%

# Theoretical parent-offspring relationship

---

class: frimg, center
background-image: url(figs/SR_relationship.png)
background-position: 50% 65%
background-size: 67%

# Real parent-offspring relationship

.citation.gray[Scheuerell et al. (2021)]

---

class: frimg, center
background-image: url(figs/ref_points0.png)
background-position: 50% 60%
background-size: 65%

# Optimal escapement for targeting MSY

.citation.gray[Scheuerell et al. (2021)]

---

class: frimg, center
background-image: url(figs/ref_points.png)
background-position: 50% 60%
background-size: 65%

# Co-management is conservation minded

.citation.gray[Scheuerell et al. (2021)]




